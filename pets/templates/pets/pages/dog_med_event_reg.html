
{% extends "global/base.html" %}

{% load static %}



{% block content %}

  <h2 class="text-center mt-3">REGISTRAR EVENTO MÉDICO</h2>      
  
  
  <form id="med_event" method="POST" enctype="multipart/form-data" action="{% url 'pet:dog_event_register' %}">
  {% csrf_token %}

        <div class="row mt-3">
        
            <div class = "card user-card me-4 mb-3 rounded shadow">
                
                <div class="card-body">
                    {%include "pets/partials/med_event_pet.html" %}
                </div>
            
            </div>
        
        </div>

    </form>

    {% include "pets/partials/modal_reg_confirmation.html" %}    

{% endblock %}
{% block scripts %}

<script>
    function toBR(dateStr){
        if(!dateStr) return '—';
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dateStr);
        return m ? `${m[3]}/${m[2]}/${m[1]}` : dateStr;
    };

    function selectedText(el){
        if(!el) return '—';
        const tag = (el.tagName || '').toUpperCase();
        if (tag === 'SELECT') {
            const i = el.selectedIndex;
            const opt = i >= 0 ? el.options[i] : null;
            return (opt && (opt.text ?? '').trim()) || '—';
        }
        return (el.value || '').trim() || '—';
    };


    const detailsBox = document.getElementById('confirmDetails');
    const confirmBtn  = document.getElementById('confirmSubmitBtn');
    const form        = document.getElementById('med_event');

    const modalEl = document.getElementById('confirmModal');
    modalEl.addEventListener('show.bs.modal', function(){
        const patientEl   = document.getElementById('id_patient');
        const dateEl      = document.getElementById('id_event_date');
        const eventEl     = document.getElementById('id_event');
        const statusEl    = document.getElementById('id_change_status'); // checkbox ou select
        const newStatusEl = document.getElementById('id_new_status'); // select

        const dogName   = selectedText(patientEl);
        const dateText  = toBR(dateEl?.value || '');
        const descText  = (eventEl?.value || '—').trim();
        const statusTxt = statusEl
            ? (statusEl.type === 'checkbox'
                ? (statusEl.checked ? 'Sim' : 'Não')
                : App.selectedText(statusEl))
            : '—';

        detailsBox.textContent =
            `Cão: ${dogName}
            Data: ${dateText}
            Descrição: ${descText}
            Altera status: ${statusTxt}
            ${statusTxt == 'Sim' ? 'Nova situação: ' : ''}`;
            });

            confirmBtn.addEventListener('click', function(){
                form.submit();
            });
</script>

<script>
  (function(){
    const changeEl   = document.getElementById('id_change_status');
    const aptitudeRow = document.getElementById('aptitudeRow');

    if (!changeEl || !aptitudeRow) return;

    function setEnabled(enabled){
      aptitudeRow.classList.toggle('is-disabled', !enabled);
      aptitudeRow.querySelectorAll('input, select, textarea, button').forEach(el => {
        el.disabled = !enabled;
      });
    }

    // estado inicial (caso venha preenchido do servidor)
    setEnabled(!!changeEl.checked);

    // ao trocar o checkbox/radio
    changeEl.addEventListener('change', () => setEnabled(!!changeEl.checked));
  })();
</script>

{% endblock %}
