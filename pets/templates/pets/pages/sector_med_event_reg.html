
{% extends "global/base.html" %}

{% load static %}



{% block content %}

  <h2 class="text-center mt-3">REGISTRAR EVENTO MÉDICO</h2>      
  
  
  <form id="med_event" method="POST" enctype="multipart/form-data" action="{% url 'pet:sector_event_register' %}">
  {% csrf_token %}

    <div class="row mt-3">
      
        <div class = "card user-card me-4 mb-3 rounded shadow">

            <div class="card-body">
                {%include "pets/partials/med_event_sector.html" %}
            </div>
        
        </div>
    
    </div>

    {% include "pets/partials/modal_reg_confirmation.html" %}  

{% endblock %}
{% block scripts %}

<script>
  // helpers locais (ou remova se já usa App.toBR/App.selectedText)
  function toBR(dateStr){
    if(!dateStr) return '—';
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dateStr);
    return m ? `${m[3]}/${m[2]}/${m[1]}` : dateStr;
  }
  function selectedText(el){
    if(!el) return '—';
    if ((el.tagName||'').toUpperCase()==='SELECT'){
      const i = el.selectedIndex;
      const opt = i >= 0 ? el.options[i] : null;
      return (opt && (opt.text ?? '').trim()) || '—';
    }
    return (el.value || '').trim() || '—';
  }

  const form        = document.getElementById('med_event');
  const modalEl     = document.getElementById('confirmModal');
  const detailsBox  = document.getElementById('confirmDetails');
  const confirmBtn  = document.getElementById('confirmSubmitBtn');

  if (modalEl && detailsBox && confirmBtn && form){
    modalEl.addEventListener('show.bs.modal', function () {
      // tenta pelos ids padrão do Django; se não achar, tenta por name
      const sectorEl = document.getElementById('id_sector') 
                    || document.querySelector('[name="sector"]')
                    || document.querySelector('[name="sector.sector"]');
      const dateEl   = document.getElementById('id_event_date')
                    || document.querySelector('[name="event_date"]');
      const eventEl  = document.getElementById('id_event')
                    || document.querySelector('[name="event"]');

      const sectorTxt = selectedText(sectorEl);
      const dateTxt   = toBR(dateEl?.value || '');
      const descTxt   = (eventEl?.value || '—').trim();

      detailsBox.textContent =
        `Setor: ${sectorTxt}
        Data: ${dateTxt}
        Descrição: ${descTxt}`;
            });

            confirmBtn.addEventListener('click', function(){
            form.submit();
            });
        }
</script>

{% endblock %}
